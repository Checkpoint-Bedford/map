<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>CHECKPOINT | Bedford Support Map</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
    }
    header {
        background: #1e3a8a;
        color: white;
        padding: 15px 25px;
        font-size: 20px;
        font-weight: bold;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    #map {
        height: calc(100vh - 70px);
        width: 100%;
    }

    /* Search bar */
    .search-box {
        position: fixed;
        top: 85px;
        left: 20px;
        width: 260px;
        z-index: 999999;
    }
    @media(max-width: 600px) {
        .search-box {
            top: 140px; /* moves down so it never overlaps */
        }
    }
    .search-input {
        width: 100%;
        padding: 10px 14px;
        border-radius: 20px;
        border: 2px solid #1e3a8a;
        box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        font-size: 15px;
        outline: none;
    }
    .search-results {
        background: white;
        border-radius: 15px;
        margin-top: 5px;
        box-shadow: 0 3px 8px rgba(0,0,0,0.25);
        overflow: hidden;
        border: 2px solid #1e3a8a;
        display: none;
    }
    .search-item {
        padding: 10px 14px;
        cursor: pointer;
        border-bottom: 1px solid #ddd;
    }
    .search-item:hover {
        background: #eef2ff;
    }

    /* Phone button */
    .phone-btn {
        position: fixed;
        top: 90px;
        right: 20px;
        background: #1e3a8a;
        color: white;
        border: 2px solid black;
        padding: 12px 16px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 15px;
        box-shadow: 0 3px 6px rgba(0,0,0,0.25);
        z-index: 999999;
    }

    /* Phone panel */
    .phone-panel {
        position: fixed;
        top: 0;
        right: -320px;
        width: 280px;
        height: 100vh;
        overflow-y: auto;
        background: #fff2f2;
        border-left: 3px solid black;
        box-shadow: -3px 0 8px rgba(0,0,0,0.3);
        padding: 20px;
        transition: right 0.35s ease;
        z-index: 999999;
    }
    .phone-panel.open {
        right: 0;
    }
    .panel-close {
        float: right;
        cursor: pointer;
        font-size: 18px;
        margin-top: -5px;
    }
</style>
</head>
<body>
<header>
    Bedford Support Map <span class="brand-tag">by CHECKPOINT</span>
</header>

<div id="map"></div>

<!-- SEARCH BAR -->
<div class="search-box">
    <input type="text" id="searchInput" class="search-input" placeholder="Search locations...">
    <div id="searchResults" class="search-results"></div>
</div>

<button class="phone-btn" onclick="togglePhonePanel()">Phone Numbers</button>

<div id="phonePanel" class="phone-panel">
    <span class="panel-close" onclick="togglePhonePanel()">✖</span>
    <h3>Useful Phone Numbers</h3>

    <ul>
        <li>Citizens Advice Bedford: <b>01234 867944</b></li>
        <li>Bedford Foodbank: <b>01234 268569</b></li>
        <li>Job centre plus: <b>0845 604 3719</b></li>
        <li>BRASS Bedford: <b>01234 211381</b></li>
        <li>SMART First Point Bedford: <b>01234 365955</b></li>
        <li>King's Arm Project: <b>01234 350900</b></li>
        <br>
        <li>CAMHS Bedford: <b>01234 893300</b></li>
        <li>Recovery Lounge Bedford: <b>01234 343869</b></li>
        <br>
        <li>YMCA Bedfordshire: <b>01234 307040</b></li>
        <li>Bedford Central Library: <b>01234 718178</b></li>
        <li>Kempston Library: <b>01234 276453</b></li>
        <li>Wootton Library: <b>01234 766061</b></li>
        <br>
        <li>Bedford Creative Arts Centre: <b>01234 818670</b></li>
        <li>Higgins Museum Bedford: <b>01234 718618</b></li>
        <br>
        <li>De Parys Medical Group: <b>01234 351341</b></li>
        <li>Priory Health Clinic: <b>01234 262040</b></li>
        <li>iCaSH Bedfordshire: <b>0300 300 3030</b></li>
        <li>Beds Fire & Rescue Group: <b>01234 845000</b></li>
        <li>Bedford Talking therapy: <b>01234 880400</b></li>
        <li>Path to Recovery: <b>0333 332 4019</b></li>
        <li>Putnoe Medical Centre: <b>01234 319992</b></li>
        <li>Bedford Borough Social Services: <b>01234 267422</b></li>
        <li>Bedford Hospital: <b>01234 355122</b></li>
    </ul>
</div>
<script>
function togglePhonePanel() {
    document.getElementById("phonePanel").classList.toggle("open");

    // Close search suggestions when panel opens
    document.getElementById("searchResults").style.display = "none";
}

const pastel = {
    "Help Centre": "#d62828",
    "Wellbeing": "#1d4ed8",
    "Education": "#138a36",
    "Diverse": "#7e22ce",
    "Outdoor Wellbeing": "#0e7490",
    "Local Service": "#f97316"
};

function cartoonIcon(color) {
    return L.divIcon({
        html: `<svg width="28" height="28" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" fill="${color}" stroke="black" stroke-width="3"/>
            </svg>`,
        className: "",
        iconSize: [28, 28],
        iconAnchor: [14, 14]
    });
}

const map = L.map("map", { maxZoom: 17 }).setView([52.135, -0.47], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const locations = [
    ["Citizens Advice Bedford", "MK40 1TP", "Help Centre"],
    ["Bedford Foodbank", "MK41 7PE", "Help Centre"],
    ["BRASS Bedford", "MK40 2RB", "Help Centre"],
    ["Kings Arm Project", "MK42 9AZ", "Help Centre"],
    ["SMART First Point Bedford", "MK40 3HZ", "Help Centre"],
    ["Job Centre Plus", "MK40 2EH", "Help Centre"],
    ["Bedford Hospital", "MK42 9DJ", "Help Centre"],
    ["iCaSH Bedford", "MK42 0AH", "Local Service"],
    ["CAMHS", "MK42 9DJ", "Wellbeing"],
    ["Recovery Lounge Bedford", "MK40 2NX", "Wellbeing"],
    ["Bedford Talking Therapies", "MK40 2AW", "Wellbeing"],
    ["Path to Recovery", "MK40 2RT", "Wellbeing"],
    ["Bedford Central Library", "MK40 1PG", "Education"],
    ["Kempston Library", "MK42 8AT", "Education"],
    ["Wootton Library", "MK43 9LH", "Education"],
    ["YMCA Bedfordshire", "MK40 2AA", "Education"],
    ["Bedford Creative Arts", "MK41 7PH", "Diverse"],
    ["Higgins Museum Bedford", "MK40 3XD", "Diverse"],
    ["Russell Park", "MK40 3SA", "Outdoor Wellbeing"],
    ["Priory Country Park", "MK41 9DJ", "Outdoor Wellbeing"],
    ["Addison Howard Park", "MK42 8PN", "Outdoor Wellbeing"],
    ["De Parys Medical Group", "MK40 2TX", "Local Service"],
    ["Priory Health Clinic", "MK41 6GA", "Local Service"],
    ["Queen’s Park Surgery", "MK40 4HR", "Local Service"],
    ["London Road Surgery", "MK42 0NT", "Local Service"],
    ["Beds Fire & Rescue Community", "MK41 9LN", "Local Service"],
    ["Putnoe Medical Centre", "MK41 9JE", "Local Service"],
    ["Bedford Borough Social Services", "MK42 9AP", "Local Service"]
];

// MARKERS
let markerRefs = [];

fetch("https://api.postcodes.io/postcodes", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ postcodes: locations.map(l => l[1]) })
})
.then(r => r.json())
.then(data => {
    data.result.forEach((entry, i) => {
        if (!entry.result) return;

        const [name, postcode, category] = locations[i];
        const lat = entry.result.latitude;
        const lon = entry.result.longitude;

        const marker = L.marker([lat, lon], { icon: cartoonIcon(pastel[category]) })
            .bindPopup(`<b>${name}</b><br>${postcode}`)
            .addTo(map);

        markerRefs.push({ name, lat, lon, marker });
    });
});

// SEARCH
const searchInput = document.getElementById("searchInput");
const searchResults = document.getElementById("searchResults");

searchInput.addEventListener("input", () => {
    const v = searchInput.value.toLowerCase().trim();
    if (v === "") {
        searchResults.style.display = "none";
        return;
    }

    const matches = markerRefs.filter(l => l.name.toLowerCase().includes(v));
    searchResults.innerHTML = matches.map(m => `<div class='search-item'>${m.name}</div>`).join("");

    searchResults.style.display = matches.length ? "block" : "none";

    document.querySelectorAll(".search-item").forEach((item, index) => {
        item.onclick = () => {
            const picked = matches[index];
            map.setView([picked.lat, picked.lon], 16);
            picked.marker.openPopup();
            searchResults.style.display = "none";
            searchInput.value = picked.name;
        };
    });
});
</script>
</body>
</html>
