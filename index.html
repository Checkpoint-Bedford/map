<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CHECKPOINT | Bedford Support Map</title>

<!-- Poppins font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root {
    --primary:#1e3a8a;
    --panel-w:300px;
  }

  html,body { height:100%; margin:0; font-family: 'Poppins', sans-serif; background:#fff; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

  /* Header */
  header {
    background: var(--primary);
    color: #fff;
    padding: 14px 18px;
    font-weight:700;
    font-size:20px;
    border-bottom: 3px solid #000;
    height:64px;
    box-sizing:border-box;
    display:flex;
    align-items:center;
    z-index: 99997;
    position:relative;
  }
  header .byline { font-weight:400; margin-left:10px; color:#d1d5db; font-size:13px; }

  #map { height: calc(100vh - 64px); width:100%; }

  /* Legend */
  .legend {
    position: fixed;
    bottom: 10px;
    left: 20px;
    background: #fff;
    padding: 8px 10px;
    border-radius: 8px;
    border: 2px solid #000;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    z-index: 99999;
    font-size:12px;
    line-height:1.25;
  }

  /* Top controls container to keep search and phone vertically aligned */
  .top-controls {
    position: fixed;
    left: 0;
    right: 0;
    top: 0;
    height: 64px; /* same as header */
    pointer-events: none; /* allow underlying header interactions if needed */
    z-index: 99998;
  }

  /* Search container */
  .search-box {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 999999;
    width: 200px;             /* less wide as requested */
    max-width: calc(100% - 160px); /* leave space for phone button */
    pointer-events: auto;
  }

  .search-input {
    width: 100%;
    padding: 9px 12px;
    border-radius: 999px;
    border: 2px solid var(--primary);
    box-shadow: 0 6px 14px rgba(0,0,0,0.12);
    outline: none;
    font-size: 14px;
    box-sizing: border-box;
    background: #fff;
  }

  .search-suggestions {
    display: none;
    margin-top: 8px;
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    border: 2px solid var(--primary);
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
    max-height: 260px;
    overflow-y: auto;
  }

  .suggestion {
    display:flex;
    gap:10px;
    align-items:center;
    padding:10px 12px;
    cursor:pointer;
    border-bottom:1px solid #eee;
    font-size:14px;
  }
  .suggestion:last-child { border-bottom: none; }
  .suggestion:hover { background: #eef2ff; }

  /* Dot: ensure true circle (equal width+height) and no flex distortion */
  .dot {
    width:14px;
    height:14px;
    border-radius:50%;
    border:2px solid #000;
    box-sizing:border-box;
    flex: 0 0 auto; /* do NOT stretch to different width/height */
    margin: 0; /* keep consistent spacing handled by gap */
    display:inline-block;
    vertical-align:middle;
  }

  .label { line-height:1.05; }

  /* highlight match */
  .match { font-weight:700; background: linear-gradient(transparent 60%, rgba(255,230,230,0.6) 60%); }

  /* Phone button */
  .phone-btn {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    background: var(--primary);
    color: white;
    border: 2px solid black;
    padding: 12px 16px;
    border-radius: 28px;
    cursor: pointer;
    font-size: 15px;
    z-index: 999999;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    font-weight:600;
    pointer-events: auto;
  }

  /* Phone panel: use transform to hide off-screen so it never "sticks out" */
  .phone-panel {
    position: fixed;
    top: 0;
    right: 0;
    width: var(--panel-w);
    height: 100vh;
    background: #fff2f2;
    border-left: 3px solid black;
    padding: 18px;
    box-shadow: -3px 0 8px rgba(0,0,0,0.25);
    transform: translateX(100%); /* hidden (moved fully out) */
    transition: transform 0.32s ease;
    z-index: 999999;
    overflow-y: auto;
    box-sizing: border-box;
  }
  .phone-panel.open { transform: translateX(0); }
  .panel-close { float:right; cursor:pointer; font-size:18px; }

  /* credit moved to bottom-right */
  .credit {
    position: fixed;
    bottom: 6px;
    right: 8px;
    font-size: 10px;
    color: gray;
    opacity: 0.65;
    z-index: 500;
  }

  /* Accessibility focus */
  .search-input:focus { box-shadow: 0 8px 20px rgba(30,58,138,0.16); }

  /* Responsive adjustments */
  @media (max-width: 600px) {
    .search-box { left: 12px; width: 170px; }
    .phone-btn { right: 12px; padding:10px 14px; font-size:14px; }
    .legend { left: 10px; bottom: 70px; }
    .credit { right:6px; bottom:6px; }
    .search-box { max-width: calc(100% - 120px); }
  }

  /* Ensure map sits under header and top-controls */
  #map { z-index: 0; position: relative; }

</style>
</head>
<body>
<header>Bedford Support Map <span class="byline">by CHECKPOINT</span></header>

<!-- top invisible layer that holds search + phone so they align with the header -->
<div class="top-controls" aria-hidden="true">
  <div class="search-box" style="pointer-events:auto;">
    <input id="searchInput" class="search-input" placeholder="Search locations..." autocomplete="off" />
    <div id="suggestions" class="search-suggestions" role="listbox" aria-label="Search suggestions"></div>
  </div>

  <button class="phone-btn" id="phoneBtn" aria-controls="phonePanel" aria-expanded="false">üìû Phone Numbers</button>
</div>

<div id="map"></div>

<!-- Legend -->
<div class="legend" id="legend" aria-hidden="false">
  <b>Index</b><br><br>
  <i style="color:#d62828;">‚óè</i> Help Centres<br>
  <i style="color:#1d4ed8;">‚óè</i> Mental Health & Wellbeing<br>
  <i style="color:#138a36;">‚óè</i> Education & Youth<br>
  <i style="color:#7e22ce;">‚óè</i> Diverse Centres<br>
  <i style="color:#0e7490;">‚óè</i> Outdoor Wellbeing<br>
  <i style="color:#f97316;">‚óè</i> Local Services<br>
</div>

<!-- Phone panel -->
<div id="phonePanel" class="phone-panel" aria-hidden="true">
  <span class="panel-close" id="panelClose" role="button" aria-label="Close panel">‚úñ</span>
  <h3>Useful Phone Numbers</h3>
  <ul>
    <li>Citizens Advice Bedford: <b>01234 867944</b></li>
    <li>Bedford Foodbank: <b>01234 268569</b></li>
    <li>Job centre plus: <b>0845 604 3719</b></li>
    <li>BRASS Bedford: <b>01234 211381</b></li>
    <li>SMART First Point Bedford: <b>01234 365955</b></li>
    <li>King's Arm Project: <b>01234 350900</b></li>
    <br>
    <li>CAMHS Bedford: <b>01234 893300</b></li>
    <li>Recovery Lounge Bedford: <b>01234 343869</b></li>
    <br>
    <li>YMCA Bedfordshire: <b>01234 307040</b></li>
    <li>Bedford Central Library: <b>01234 718178</b></li>
    <li>Kempston Library: <b>01234 276453</b></li>
    <li>Wootton Library: <b>01234 766061</b></li>
    <br>
    <li>Bedford Creative Arts Centre: <b>01234 818670</b></li>
    <li>Higgins Museum Bedford: <b>01234 718618</b></li>
    <br>
    <li>De Parys Medical Group: <b>01234 351341</b></li>
    <li>Priory Health Clinic: <b>01234 262040</b></li>
    <li>iCaSH Bedfordshire: <b>0300 300 3030</b></li>
    <li>Beds Fire & Rescue Group: <b>01234 845000</b></li>
    <li>Bedford Talking therapy: <b>01234 880400</b></li>
    <li>Path to Recovery: <b>0333 332 4019</b></li>
    <li>Putnoe Medical Centre: <b>01234 319992</b></li>
    <li>Bedford Borough Social Services: <b>01234 267422</b></li>
    <li>Bedford Hospital: <b>01234 355122</b></li>
  </ul>
</div>

<!-- credit -->
<div class="credit">Made by Aaima Shabir</div>

<script>
/* -------------------------
   Map & markers setup
   ------------------------- */
const pastel = {
  "Help Centre": "#d62828",
  "Wellbeing": "#1d4ed8",
  "Education": "#138a36",
  "Diverse": "#7e22ce",
  "Outdoor Wellbeing": "#0e7490",
  "Local Service": "#f97316"
};

function cartoonIcon(color) {
  return L.divIcon({
    html: `<svg width="30" height="30" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
             <circle cx="50" cy="50" r="40" fill="${color}" stroke="black" stroke-width="4"/>
           </svg>`,
    className: "",
    iconSize: [30, 30],
    iconAnchor: [15, 15]
  });
}

const map = L.map('map', { maxZoom: 17 }).setView([52.135, -0.47], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

/* Full list of locations (name, postcode, category, optional description) */
const locations = [
    ["Citizens Advice Bedford", "MK40 1TP", "Help Centre", "(add description here)"],
    ["Bedford Foodbank", "MK41 7PE", "Help Centre", "(add description here)"],
    ["BRASS Bedford", "MK40 2RB", "Help Centre", "(add description here)"],
    ["Kings Arm Project", "MK42 9AZ", "Help Centre", "(add description here)"],
    ["SMART First Point Bedford", "MK40 3HZ", "Help Centre", "(add description here)"],
    ["Job Centre Plus", "MK40 2EH", "Help Centre", "(add description here)"],
    ["Bedford Hospital", "MK42 9DJ", "Help Centre", "(A&E, crisis support available)"],
    ["iCaSH Bedford", "MK42 0AH", "Local Service", "Sexual Health Clinic ‚Äì offers STI testing, advice & contraception"],
    ["CAMHS", "MK42 9DJ", "Wellbeing", "(add description here)"],
    ["Recovery Lounge Bedford", "MK40 2NX", "Wellbeing", "(add description here)"],
    ["Bedford Talking Therapies", "MK40 2AW", "Wellbeing", "(add description here)"],
    ["Path to Recovery", "MK40 2RT", "Wellbeing", "(add description here)"],
    ["Bedford Central Library", "MK40 1PG", "Education", "(add description here)"],
    ["Kempston Library", "MK42 8AT", "Education", "(add description here)"],
    ["Wootton Library", "MK43 9LH", "Education", "(add description here)"],
    ["YMCA Bedfordshire", "MK40 2AA", "Education", "(add description here)"],
    ["Bedford Creative Arts", "MK41 7PH", "Diverse", "(add description here)"],
    ["Higgins Museum Bedford", "MK40 3XD", "Diverse", "(add description here)"],
    ["Russell Park", "MK40 3SA", "Outdoor Wellbeing", "(add description here)"],
    ["Priory Country Park", "MK41 9DJ", "Outdoor Wellbeing", "(add description here)"],
    ["Addison Howard Park", "MK42 8PN", "Outdoor Wellbeing", "(add description here)"],
    ["De Parys Medical Group", "MK40 2TX", "Local Service", "(add description here)"],
    ["Priory Health Clinic", "MK41 6GA", "Local Service", "(add description here)"],
    ["Queen‚Äôs Park Surgery", "MK40 4HR", "Local Service", "(add description here)"],
    ["London Road Surgery", "MK42 0NT", "Local Service", "(add description here)"],
    ["Beds Fire & Rescue Community", "MK41 9LN", "Local Service", "(add description here)"],
    ["Putnoe Medical Centre", "MK41 9JE", "Local Service", "(add description here)"],
    ["Bedford Borough Social Services", "MK42 9AP", "Local Service", "(add description here)"]
];

/* markerRefs will hold created marker objects and metadata for searching */
const markerRefs = [];

/* Fetch coordinates for all postcodes via postcodes.io (bulk) */
fetch("https://api.postcodes.io/postcodes", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ postcodes: locations.map(l => l[1]) })
})
.then(r => r.json())
.then(data => {
  data.result.forEach((res, i) => {
    if (!res.result) return;

    const [name, postcode, category, description] = locations[i];
    const lat = res.result.latitude;
    const lon = res.result.longitude;

    const marker = L.marker([lat, lon], { icon: cartoonIcon(pastel[category] || "#999999") })
      .bindPopup(`<b>${name}</b><br>${postcode}<br><i style="color:#555">${description || ''}</i>`)
      .addTo(map);

    markerRefs.push({ name, postcode, category, description, lat, lon, marker });
  });
})
.catch(err => {
  console.error("postcode lookup failed", err);
});

/* -------------------------
   Search/autocomplete UI
   ------------------------- */
const input = document.getElementById('searchInput');
const suggestionsEl = document.getElementById('suggestions');

function escapeRegex(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

input.addEventListener('input', () => {
  const q = input.value.trim().toLowerCase();
  if (!q) { suggestionsEl.style.display='none'; suggestionsEl.innerHTML=''; return; }

  const matches = markerRefs.filter(m => m.name.toLowerCase().includes(q)).slice(0, 10);

  if (matches.length === 0) {
    suggestionsEl.style.display='none';
    suggestionsEl.innerHTML = '';
    return;
  }

  const html = matches.map(m => {
    const re = new RegExp('(' + escapeRegex(q) + ')', 'ig');
    const highlighted = m.name.replace(re, '<span class="match">$1</span>');

    const color = pastel[m.category] || '#888';
    return `<div class="suggestion" role="option" data-lat="${m.lat}" data-lon="${m.lon}">
              <div class="dot" style="background:${color}"></div>
              <div class="label">${highlighted}<div style="font-size:12px;color:#666">${m.postcode}</div></div>
            </div>`;
  }).join('');
  suggestionsEl.innerHTML = html;
  suggestionsEl.style.display = 'block';

  suggestionsEl.querySelectorAll('.suggestion').forEach((el, idx) => {
    el.onclick = () => {
      const lat = parseFloat(el.dataset.lat);
      const lon = parseFloat(el.dataset.lon);
      const picked = matches[idx];
      map.setView([lat, lon], 15);
      if (picked && picked.marker) picked.marker.openPopup();
      suggestionsEl.style.display = 'none';
      input.value = picked ? picked.name : '';
    };
  });
});

/* Hide suggestions when clicked outside */
document.addEventListener('click', (e) => {
  const box = document.querySelector('.search-box');
  if (!box.contains(e.target)) suggestionsEl.style.display = 'none';
});

/* Close suggestions if phone panel opens, and vice versa */
const phoneBtn = document.getElementById('phoneBtn');
const phonePanel = document.getElementById('phonePanel');
const panelClose = document.getElementById('panelClose');

function openPhonePanel() {
  phonePanel.classList.add('open');
  phonePanel.setAttribute('aria-hidden','false');
  phoneBtn.setAttribute('aria-expanded','true');
  suggestionsEl.style.display = 'none';
}
function closePhonePanel() {
  phonePanel.classList.remove('open');
  phonePanel.setAttribute('aria-hidden','true');
  phoneBtn.setAttribute('aria-expanded','false');
}

phoneBtn.addEventListener('click', () => {
  if (phonePanel.classList.contains('open')) closePhonePanel();
  else openPhonePanel();
});

panelClose.addEventListener('click', closePhonePanel);

document.addEventListener("gesturestart", e => e.preventDefault());
document.addEventListener("gesturechange", e => e.preventDefault());
document.addEventListener("gestureend", e => e.preventDefault());
</script>
</body>
</html>

